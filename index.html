<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Set character encoding and viewport for responsiveness -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    <!-- Link to main stylesheet -->
    <link rel="stylesheet" href="style.css">
    <!-- Link to Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Include Leaflet JavaScript library -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Include Leaflet Control Geocoder for geocoding -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</head>
<body>
    <!-- Container for all page elements -->
    <div class="cards">
        <!-- Block for city search -->
        <div class="sticky">
            <div class="search">
                <!-- Input field for entering city name -->
                <input type="text" placeholder="Enter city name" spellcheck="false">            
                <!-- Button for triggering weather search -->
                <div class="buttons">
                    <button>Search</button>
                </div>
            </div>
        </div>
        
        <!-- Block for map display -->
        <div id="map"></div>
        
        <!-- Block for main weather information -->
        <div class="weather">
            <!-- Weather icon -->
            <img src="" class="weather-icon" alt="Weather Icon">
            <!-- Current temperature -->
            <h1 class="temp"></h1>
            <!-- City name -->
            <h2 class="city"></h2>
            <!-- Additional weather information (humidity, wind speed) -->
            <div class="details">
                <div class="col">
                    <!-- Humidity icon -->
                    <img src="https://openweathermap.org/img/wn/09d@2x.png" alt="Humidity Icon">
                    <!-- Humidity value -->
                    <div>
                        <p class="humidity"></p>
                        <p>Humidity</p>
                    </div>
                </div>
                <div class="col">
                    <!-- Wind speed icon -->
                    <img src="https://openweathermap.org/img/wn/50d@2x.png" alt="Wind Speed Icon">
                    <!-- Wind speed value -->
                    <div>
                        <p class="wind"></p>
                        <p>Wind Speed</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Container for weather forecast for multiple days -->
        <div class="slider-container" id="weatherForecast"></div>
    </div>
    
    <!-- JavaScript code for functionality -->
    <script>
        // API key for OpenWeatherMap
        const apiKey = "36aa82a0a89fb8e313e0af79be98237c";

        // Function to fetch weather by coordinates
        async function getWeatherByCoords(lat, lon) {
            // API URL for current weather data
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?units=metric&lat=${lat}&lon=${lon}&appid=${apiKey}`;
            try {
                // Fetch weather data
                const response = await fetch(apiUrl);
                const data = await response.json();
                // Update weather information
                updateWeatherInfo(data);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
            // Get weekly forecast
            getWeeklyForecast(lat, lon);
        }

        // Function to fetch weekly forecast by coordinates
        async function getWeeklyForecast(lat, lon) {
            // API URL for weekly forecast data
            const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?units=metric&lat=${lat}&lon=${lon}&appid=${apiKey}`;
            try {
                // Fetch weekly forecast data
                const response = await fetch(forecastUrl);
                const data = await response.json();

                // Get container for weather forecast
                const weatherForecastContainer = document.getElementById('weatherForecast');
                weatherForecastContainer.innerHTML = ''; 

                // Sort the forecast data by timestamp
                const sortedData = data.list.sort((a, b) => a.dt - b.dt);

                // Create weather cards for each day
                sortedData.forEach(day => {
                    const card = createWeatherCard(day);
                    weatherForecastContainer.appendChild(card);
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Function to fetch weather by city name
        async function getWeatherByCity(city) {
            // API URL for current weather data by city name
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?units=metric&q=${encodeURIComponent(city)}&appid=${apiKey}`;

            try {
                // Fetch weather data
                const response = await fetch(apiUrl);
                const data = await response.json();
                // Update weather information
                updateWeatherInfo(data);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
            // Get weekly forecast
            getWeeklyForecast2(city);
        }

        // Function to fetch weekly forecast by city name
        async function getWeeklyForecast2(city) {
            // API URL for weekly forecast data by city name
            const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&units=metric&appid=${apiKey}`;
            try {
                // Fetch weekly forecast data
                const response = await fetch(apiUrl);
                const data = await response.json();

                // Get container for weather forecast
                const weatherForecastContainer = document.getElementById('weatherForecast');
                weatherForecastContainer.innerHTML = '';

                // Sort the forecast data by timestamp
                const sortedData = data.list.sort((a, b) => a.dt - b.dt);

                // Create weather cards for each day
                sortedData.forEach(day => {
                    const card = createWeatherCard(day);
                    weatherForecastContainer.appendChild(card);
                });
            } catch (error) {
                console.error("Error fetching weekly forecast data:", error);
            }
        }

        // Function to handle geolocation success
        function geolocationSuccess(pos) {
            // Get user's coordinates
            const crd = pos.coords;
            const lat = crd.latitude;
            const lon = crd.longitude;

            // Initialize Leaflet map
            var map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add marker to map
            var marker = L.marker([lat, lon]).addTo(map);

            // Add geocoding control to map
            L.Control.geocoder().addTo(map);

            // Function to get city name by coordinates
            function getCityNameByCoords(latitude, longitude) {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`)
                    .then(response => response.json())
                    .then(data => {
                        // Extract city name from reverse geocoding response
                        let cityName = data.address.city || data.address.town || data.address.village || data.address.country;
                      
                      // Set the input field value to the city name
                      document.querySelector(".search input").value = cityName;
                  })
                  .catch(error => {
                      console.error('Error:', error);
                  });
          }

          // Function to handle map click event
          function onMapClick(e) {
              if (marker) {
                  map.removeLayer(marker);
              }
              marker = new L.Marker(e.latlng).addTo(map);
              // Get city name and weather data for clicked location
              getCityNameByCoords(e.latlng.lat, e.latlng.lng);
              getWeatherByCoords(e.latlng.lat, e.latlng.lng);
          }

          // Add click event listener to the map
          map.on('click', onMapClick);

          // Fetch weather data and city name for user's coordinates
          getWeatherByCoords(lat, lon);
          getCityNameByCoords(lat, lon);
          getWeeklyForecast(lat, lon);
      }

      // Function to handle geolocation error
      function geolocationError(err) {
          console.warn(`ERROR(${err.code}): ${err.message}`);
      }

      // Options for geolocation
      const options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0,
      };

      // Get user's current position using geolocation
      navigator.geolocation.getCurrentPosition(geolocationSuccess, geolocationError, options);

      // Function to create a weather card for a day
      function createWeatherCard(day) {
          const card = document.createElement('div');
          card.classList.add('weather-card');

          // Get date and time information
          const dateObj = new Date(day.dt * 1000);
          const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
          const date = dateObj.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '.');
          const time = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

          // Create elements for day information
          const dayElement = document.createElement('div');
          dayElement.classList.add('day-info');
          dayElement.innerHTML = `
              <div class="day-name">${dayOfWeek}</div>
              <div class="date">${date}</div>
              <div class="time">${time}</div>
          `;

          // Create element for temperature and weather icon
          const temperature = document.createElement('div');
          temperature.classList.add('temperature');
          temperature.innerHTML = `<img src="https://openweathermap.org/img/w/${day.weather[0].icon}.png" alt="${day.weather[0].description}">
                                  <div class="temp-details">${Math.round(day.main.temp)}°C</div>`;

          // Create element for additional weather information (wind speed and humidity)
          const additionalInfo = document.createElement('div');
          additionalInfo.classList.add('additional-info');
          additionalInfo.innerHTML = `
              <div class="info-item">
                  <img src="https://openweathermap.org/img/wn/50d@2x.png" alt="Wind Speed">
                  <div class="info-text">${day.wind.speed} m/s</div>
              </div>
              <div class="info-item">
                  <img src="https://openweathermap.org/img/wn/09d@2x.png" alt="Humidity">
                  <div class="info-text">${day.main.humidity}%</div>
              </div>
          `;

          // Append elements to weather card
          card.appendChild(dayElement);
          card.appendChild(temperature);
          card.appendChild(additionalInfo);

          return card;
      }

      // Function to update main weather information
      function updateWeatherInfo(data) {
          document.querySelector(".weather-icon").src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
          document.querySelector(".temp").textContent = `${Math.round(data.main.temp)}°C`;
          document.querySelector(".city").textContent = `${data.name}, ${data.sys.country}`;
          document.querySelector(".humidity").textContent = `${data.main.humidity}%`;
          document.querySelector(".wind").textContent = `${data.wind.speed} m/s`;
      }

      // Event listener for search button click
      const searchBtn = document.querySelector(".buttons button");
      const searchInput = document.querySelector(".search input");
      searchBtn.addEventListener("click", () => {
          const city = searchInput.value;
          if (city) {
              getWeatherByCity(city);
          }
      });
  </script>
</body>
</html>
